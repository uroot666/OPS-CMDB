{% extends "layout.html" %}

{% block title %}CMDB | 资产管理{% endblock %}

{% block nav_room %}class="active"{% endblock %}

{% block nav_asset %}class="active"{% endblock %}


{% block link %}
<link href="/static/css/plugins/dataTables/dataTables.bootstrap.css" rel="stylesheet">
<link href="/static/css/plugins/dataTables/dataTables.responsive.css" rel="stylesheet">
<link href="/static/css/plugins/dataTables/dataTables.tableTools.min.css" rel="stylesheet">
<link href="/static/css/animate.css" rel="stylesheet">
<link href="/static/css/style.css" rel="stylesheet">
<link href="/static/css/bootstrap-slider.css" rel="stylesheet">

{% endblock %}

{% block breadcrumb %}
    <li>
        <a href="javascript:void(0)">资产</a>
    </li>
    <li>
        <strong>资产管理</strong>
    </li>
{% endblock %}

{% block connect %}
    <!-- Button trigger modal -->
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#edit-dailog">
        资产创建
    </button>
    <br>
    <!-- Modal -->
    <div class="modal fade" id="edit-dailog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">资产编辑</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal form-edit">
                    <input type="hidden" name="id" value="" />
                    <div class="form-group">
                        <label class="col-sm-2 control-label">SN</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" name="sn" value="" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">主机名</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" name="hostname" value="" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">IP</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" name="ip" value="" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">厂商</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" name="vendor" value="" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">型号</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" name="model" value="" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">CPU</label>
                        <div class="col-sm-10">
                            <!-- <input type="text" class="form-control" name="cpu"> -->
                            <input type="text" name= "cpu" class="form-control" data-slider-min="1" data-slider-max="32" data-slider-step="1" data-slider-value="" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">内存</label>
                        <div class="col-sm-10">
                            <input type="text" name= "ram" class="form-control" data-slider-min="1" data-slider-max="256" data-slider-step="1" data-slider-value="" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">硬盘</label>
                        <div class="col-sm-10">
                            <input type="text" name= "disk" class="form-control" data-slider-min="50" data-slider-max="1000" data-slider-step="1" data-slider-value="" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">使用者</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" name="admin" value="" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">业务</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" name="buiness" value="" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">机房</label>
                        <div class="col-sm-10">
                            <select class="form-control m-b" name="machine_room_id" value="" />
                                <option value="1">乐到家机房</option>
                                <option value="2">阿里云</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">上架时间</label>
                        <div class="col-sm-10">
                            <input type="date" class="form-control" name="time_on_shelves" value="" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">过保时间</label>
                        <div class="col-sm-10">
                            <input type="date" class="form-control" name="over_guaranteed_date" value="" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">状态</label>
                        <div class="col-sm-10">
                            <select class="form-control m-b" name="machine_room_id" >
                                <option selected="selected" value="0">使用</option>
                                <option value="1">维护</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            <button type="button" class="btn btn-primary btn-edit-save">更新</button>
            </div>
        </div>
        </div>
    </div>

    <table class="asset table table-bordered table-condensed  table-striped">
        <thead>
        <tr>
            <th>SN</th>
            <th>主机名/IP</th>
            <th>OS</th>
            <th>CPU/内存/硬盘</th>
            <th>业务</th>
            <th>管理员</th>
            <th>机房</th>
            <th>上架/过保时间</th>
            <th>厂商/型号</th>
            <th>状态</th>
            <th>操作</th>
        </tr>
        </thead>
        <tbody>
            
        </tbody>
    </table>
{% endblock %}

{% block script %}
<script src="/static/js/plugins/dataTables/jquery.dataTables.js"></script>
<script src="/static/js/plugins/dataTables/dataTables.bootstrap.js"></script>
<script src="/static/js/plugins/dataTables/dataTables.responsive.js"></script>
<script src="/static/js/plugins/dataTables/dataTables.tableTools.min.js"></script>
<script type="text/javascript" src="/static/js/bootstrap-slider.js"></script>

{% endblock %}

{% block js %}

//databable 显示资产信息
jQuery(document).ready(function(){
    var table = jQuery('.asset').dataTable({
                responsive: true,
                "dom": 'T<"clear">lfrtip',
                "tableTools": {
                    "sSwfPath":  "/static/js/plugins/dataTables/swf/copy_csv_xls_pdf.swf"
                },
                "ajax": "/asset/list/",
                "columns": [
                    { "data": "sn" },
                    {"data": function(row) {
                        return row["hostname"] + '/' + row["ip"];
                        }
                    },
                    {"data": "os"},
                    {"data": function(row) {
                       var elements = [];
                       elements.push(row["cpu"] + "核")
                       elements.push(row["ram"] + "G")
                       elements.push(row["disk"] + "G")
                       return elements.join('/')
                    }},
                    {"data": "buiness"},
                    {"data": "admin"},
                    {"data": "machine_room_id"},
                    {"data": function(row) {
                        var elements = [];
                        elements.push(row["time_on_shelves"]);
                        elements.push(row["over_guaranteed_date"]);
                        return elements.join("/")
                    }},
                    {"data": function(row) {
                        var elements = [];
                        elements.push(row["vendor"]);
                        elements.push(row["model"]);
                        return elements.join("/");
                    }},
                    {"data": function(row) {
                        return row["status"] == 1 ? "使用":"维护" ;
                    }},
                    {"data": function(row) {
                        var elements = [];
                        elements.push("<a href='javascript:void(0)'><i class='fa fa-edit btn-edit'" 
                            + "data-id=" + row['id'] + ">修改</i></a>");
                        elements.push("<a href='javascript:void(0)'><i class='fa fa-trash btn-delete'" 
                            + "data-id=" + row['id'] + ">删除</i></a>");
                        return elements.join(" ");
                    }}
                    ]
            });

    //资产添加
    jQuery('.create_btn').on('click', function() {
        jQuery.post('/asset/save/',
                    jQuery('.create_form').serializeArray(),
                    function(data){
                        if(data['code'] === 200){
                            window.location.reload();
                        }
                        else if(data['code'] === 400){
                            alert('error');
                        }
                    },'json');
            });
    
    //资产删除
    jQuery('.asset').on('click', '.btn-delete', function() {
        var url = '/asset/delete/?id=' + jQuery(this).data('id');
        alert('删除:' + jQuery(this).data('id'));
        });
    
    //资产修改
    jQuery('.asset').on('click', '.btn-edit', function() {
        jQuery.get('/asset/view/',
                {"id" : jQuery(this).data('id')},
                function(response) {
                    for (var key in response) {
                        if (key == 'cpu' || key == 'ram' || key == 'disk') {
                            jQuery('input[name=' + key + ']').slider('setValue', response[key])
                        } else {
                            jQuery("[name=" + key + "]").val(response[key]);
                        }
                    }
                    jQuery("#edit-dailog").modal("show")
                },
                'json');
        });
    //保存资产修改
    jQuery('.btn-edit-save').on('click', function () {
        var params = jQuery(".form-edit").serializeArray();
        //params[6]["cpu"] = jQuery('input[name=cpu]').slider('getValue');
        console.log(params)
        jQuery.post('/asset/update/', params, function(response) { 
            if(response['code'] === 200){
                jQuery("#edit-dailog").modal("hide");
                table.api().ajax.reload();
            }
            else if(response['code'] === 400){
                alert('error');
            }
        },
        'json')
    });
    //CPU滑块,slider插件使用
    jQuery('input[name=cpu]').slider({
        formatter: function(value) {
            return 'CPU: ' + value;
        }
    });
    //内存滑块,slider插件使用
    jQuery('input[name=ram]').slider({
        formatter: function(value) {
            return '内存: ' + value;
        }
    });
    //硬盘滑块,slider插件使用
    jQuery('input[name=disk]').slider({
        formatter: function(value) {
            return '硬盘: ' + value;
        }
    });
});
{% endblock %}